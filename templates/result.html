<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sales File Result</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      padding: 2rem;
    }
    h2 {
      margin-top: 2rem;
    }
    .btn-download {
      margin-top: 1rem;
    }
    td input {
      width: 100%;
      border: none;
      background-color: transparent;
    }
    td input:focus {
      outline: none;
      background-color: #f0f8ff;
    }
    .remove-row-btn {
      cursor: pointer;
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1 class="mb-4">üìä Sales File Analysis</h1>

  <div>
    <h2>‚úÖ Clean Sales Data</h2>
    <div id="clean-table">{{ sales_clean_html | safe }}</div>
    <button class="btn btn-success btn-download" onclick="downloadTableAsExcel('clean-table', 'clean_sales')">
      ‚¨áÔ∏è Download Clean File
    </button>
  </div>

  {% if sales_dirty_html %}
  <div>
    <h2 class="text-danger">‚ö†Ô∏è Dirty Sales Data</h2>
    <div id="dirty-table-wrapper">
      <table id="dirty-table" class="table table-bordered table-danger">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    <button class="btn btn-danger btn-download" onclick="downloadTableAsExcel('dirty-table', 'dirty_sales')">
      ‚¨áÔ∏è Download Dirty File
    </button>
    <button class="btn btn-warning btn-download" onclick="moveSelectedRowsToCleanTable()">
      ‚ú® Make Changes
    </button>
  </div>
  {% endif %}

  <script>
    function downloadTableAsExcel(tableId, baseName) {
      const originalTable = document.getElementById(tableId);
      if (!originalTable) return;

      // Clone the table to avoid modifying the DOM
      const clone = originalTable.cloneNode(true);

      // Convert all <input> fields to plain text content
      clone.querySelectorAll("input").forEach(input => {
        const td = input.parentElement;
        td.textContent = input.type === "checkbox" ? (input.checked ? "‚úî" : "") : input.value;
      });

      // Remove the last column from all rows (including header)
      for (let row of clone.rows) {
        row.deleteCell(row.cells.length - 1);
      }

      // Extract SALE_DATE from the first row, first cell
      let dateText = "unknown-date";
      const firstRow = clone.querySelector("tbody tr");
      if (firstRow) {
        const rawDate = firstRow.cells[0].textContent.trim(); // assuming SALE_DATE is first column
        const parts = rawDate.split("/");
        if (parts.length === 3) {
          const [mm, dd, yyyy] = parts;
          dateText = `${yyyy}-${mm.padStart(2, '0')}-${dd.padStart(2, '0')}`;
        }
      }

      const filename = `${baseName}_${dateText}.xlsx`;

      // Convert table to workbook and save
      const workbook = XLSX.utils.table_to_book(clone, { sheet: "Sheet1" });
      XLSX.writeFile(workbook, filename);
    }

    window.onload = function () {
      // Build editable dirty table
      const dirtyWrapper = document.getElementById("dirty-table-wrapper");
      if (dirtyWrapper) {
        const parser = new DOMParser();
        const tempDoc = parser.parseFromString(`{{ sales_dirty_html | safe }}`, 'text/html');
        const table = tempDoc.querySelector("table");
        if (table) {
          const head = table.querySelector("thead");
          const body = table.querySelector("tbody");
          const dirtyTable = document.getElementById("dirty-table");

          const newHeaderRow = dirtyTable.querySelector("thead").insertRow();
          for (let cell of head.rows[0].cells) {
            const th = document.createElement("th");
            th.textContent = cell.textContent;
            newHeaderRow.appendChild(th);
          }
          const selectTh = document.createElement("th");
          selectTh.textContent = "‚úî";
          newHeaderRow.appendChild(selectTh);

          for (let row of body.rows) {
            const newRow = dirtyTable.querySelector("tbody").insertRow();
            for (let cell of row.cells) {
              const td = document.createElement("td");
              const input = document.createElement("input");
              input.value = cell.textContent;
              td.appendChild(input);
              newRow.appendChild(td);
            }
            const checkboxTd = document.createElement("td");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkboxTd.appendChild(checkbox);
            newRow.appendChild(checkboxTd);
          }
        }
      }

      // Add ‚ùå button to clean table rows
      const cleanTable = document.getElementById("clean-table").querySelector("table");
      if (cleanTable) {
        const header = cleanTable.querySelector("thead tr");
        const th = document.createElement("th");
        th.textContent = "‚ùå";
        header.appendChild(th);

        Array.from(cleanTable.querySelectorAll("tbody tr")).forEach(row => {
          const td = document.createElement("td");
          const btn = document.createElement("span");
          btn.className = "remove-row-btn";
          btn.textContent = "‚ùå";
          btn.onclick = () => moveRowToDirtyTable(row);
          td.appendChild(btn);
          row.appendChild(td);
        });
      }
    };

    function moveRowToDirtyTable(row) {
      const dirtyTableWrapper = document.getElementById("dirty-table-wrapper");
      let dirtyTable = document.getElementById("dirty-table");

      // If dirty table doesn't exist, create it
      if (!dirtyTableWrapper) {
        const section = document.createElement("div");
        section.innerHTML = `
          <h2 class="text-danger">‚ö†Ô∏è Dirty Sales Data</h2>
          <div id="dirty-table-wrapper">
            <table id="dirty-table" class="table table-bordered table-danger">
              <thead><tr></tr></thead>
              <tbody></tbody>
            </table>
            <button class="btn btn-danger btn-download" onclick="downloadTableAsExcel('dirty-table', 'dirty_sales')">‚¨áÔ∏è Download Dirty File</button>
            <button class="btn btn-warning btn-download" onclick="moveSelectedRowsToCleanTable()">‚ú® Make Changes</button>
          </div>`;
        document.body.appendChild(section);
        dirtyTable = document.getElementById("dirty-table");

        // Copy header from clean table
        const cleanHeaders = row.parentElement.parentElement.querySelector("thead tr").cloneNode(true);
        const dirtyHeader = dirtyTable.querySelector("thead tr");
        for (let i = 0; i < cleanHeaders.cells.length - 1; i++) {
          const th = document.createElement("th");
          th.textContent = cleanHeaders.cells[i].textContent;
          dirtyHeader.appendChild(th);
        }
        const checkTh = document.createElement("th");
        checkTh.textContent = "‚úî";
        dirtyHeader.appendChild(checkTh);
      }

      // Copy row to dirty
      const dirtyBody = dirtyTable.querySelector("tbody");
      const newRow = dirtyBody.insertRow();
      for (let i = 0; i < row.cells.length - 1; i++) {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.value = row.cells[i].textContent.trim();
        td.appendChild(input);
        newRow.appendChild(td);
      }
      const checkboxTd = document.createElement("td");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkboxTd.appendChild(checkbox);
      newRow.appendChild(checkboxTd);

      // Remove from clean
      row.remove();
    }

    function moveSelectedRowsToCleanTable() {
      const dirtyTable = document.getElementById("dirty-table");
      const cleanTableBody = document.getElementById("clean-table").querySelector("table tbody");

      Array.from(dirtyTable.querySelectorAll("tbody tr")).forEach(row => {
        const checkbox = row.querySelector("input[type='checkbox']");
        if (checkbox && checkbox.checked) {
          const newRow = cleanTableBody.insertRow();
          for (let i = 0; i < row.cells.length - 1; i++) {
            const td = document.createElement("td");
            td.textContent = row.cells[i].querySelector("input").value;
            newRow.appendChild(td);
          }

          // Add ‚ùå button back
          const td = document.createElement("td");
          const btn = document.createElement("span");
          btn.className = "remove-row-btn";
          btn.textContent = "‚ùå";
          btn.onclick = () => moveRowToDirtyTable(newRow);
          td.appendChild(btn);
          newRow.appendChild(td);

          row.remove();
        }
      });
    }
  </script>
</body>
</html>
