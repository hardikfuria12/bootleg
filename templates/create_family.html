<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create Families</title>
  <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 6px;
    }
    .container {
      display: flex;
      gap: 40px;
    }
    .family-box {
      border: 1px solid #aaa;
      padding: 10px;
      margin: 5px 0;
    }
    .family-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .scm-list {
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <h2>üë§ User: {{ user_id }}</h2>
  <h3>üì¶ Pending Products (not assigned to any family)</h3>

  <div id="pending-table-container">
    {{ pending_code_table|safe }}
  </div>

  <h3>Create New Family</h3>
  <input type="text" id="new-family-name" placeholder="Enter new family name" />
  <button onclick="createNewFamily()">Create Family</button>

  <h3>Grouped Families</h3>
  <div id="families-container"></div>

  <br><hr>
  <button onclick="submitFamilies()">‚úÖ Submit Grouped Families</button>

  <script>
    (function () {
      const initialFamilies = {{ families | tojson }};
      const sessionId = "{{ session }}";
      const userId = "{{ user_id }}";

      let familiesData = { ...initialFamilies };

      function renderFamilies() {
        const container = document.getElementById("families-container");
        container.innerHTML = "";
        for (const [family, codes] of Object.entries(familiesData)) {
          const box = document.createElement("div");
          box.className = "family-box";
          box.innerHTML = `
            <div class="family-header">
              <strong>${family}</strong>
              <button onclick="removeFamily('${family}')">‚ùå Delete Family</button>
            </div>
            <div class="scm-list">
              ${codes.map(code => `
                <span>${code} <button onclick="removeCodeFromFamily('${family}', '${code}')">‚Ü©Ô∏è</button></span>
              `).join('<br>')}
            </div>
          `;
          container.appendChild(box);
        }
      }

      window.createNewFamily = function () {
        const name = document.getElementById("new-family-name").value.trim();
        if (!name) {
          alert("Please enter a valid family name.");
          return;
        }

        if (familiesData[name]) {
          alert("Family name already exists.");
          return;
        }

        const selected = [...document.querySelectorAll("input.scm-checkbox:checked")].map(cb => cb.value);
        if (selected.length === 0) {
          alert("Please select at least one SCM code.");
          return;
        }

        familiesData[name] = selected;
        removeRowsFromPending(selected);
        renderFamilies();
      };

      function removeRowsFromPending(codes) {
        for (const code of codes) {
          const row = document.querySelector(`tr[data-scm="${code}"]`);
          if (row) row.remove();
        }
      }

      function addRowToPending(code) {
        const table = document.querySelector("#pending-table-container table tbody");
        const newRow = document.createElement("tr");
        newRow.setAttribute("data-scm", code);
        newRow.innerHTML = `
          <td><input type="checkbox" class="scm-checkbox" value="${code}"></td>
          <td>${code}</td>
        `;
        table.appendChild(newRow);
      }

      window.removeCodeFromFamily = function (family, code) {
        familiesData[family] = familiesData[family].filter(c => c !== code);
        if (familiesData[family].length === 0) {
          delete familiesData[family];
        }
        addRowToPending(code);
        renderFamilies();
      };

      window.removeFamily = function (family) {
        const codes = familiesData[family];
        delete familiesData[family];
        codes.forEach(code => addRowToPending(code));
        renderFamilies();
      };

      window.submitFamilies = function () {
        fetch("/save_families", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            user_id: userId,
            session: sessionId,
            families: familiesData
          })
        })
        .then(res => res.json())
        .then(data => {
          alert("‚úÖ Families saved successfully!");
          console.log("üîÅ Response from backend:", data);
        })
        .catch(err => {
          console.error("‚ùå Error submitting families:", err);
          alert("Error submitting families. See console.");
        });
      };

      renderFamilies();
    })();
  </script>
</body>
</html>
